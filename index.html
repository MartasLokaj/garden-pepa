<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Garden Pepa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  
  <style>
    .leaflet-pane,
    .leaflet-top,
    .leaflet-control {
      z-index: 1 !important;
    }
    #gardenerModal { z-index: 9999 !important; }

    @keyframes zoomIn {
      from { transform: scale(0.7); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .modal-content {
      animation: zoomIn 0.3s ease-out;
      max-height: 90vh;
      overflow-y: auto;
    }

    #fullscreenPhoto {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      justify-content: center;
      align-items: center;
      z-index: 10000;
      cursor: zoom-out;
    }
    
    #fullscreenPhoto img { 
      max-width: 95%; 
      max-height: 95%; 
      object-fit: contain;
    }

    .city-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .city-suggestion:hover {
      background-color: #f3f4f6;
    }
    
    .city-suggestion:last-child {
      border-bottom: none;
    }

    .loading-spinner {
      animation: spin 1s linear infinite;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #10b981;
      border-radius: 50%;
    }

    .error-message {
      background-color: #fee2e2;
      color: #dc2626;
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 14px;
    }

    .success-message {
      background-color: #d1fae5;
      color: #065f46;
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 14px;
    }

    .language-switcher {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.1);
      padding: 4px;
      border-radius: 8px;
    }

    .lang-btn {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
    }

    .lang-btn.active {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .lang-btn:not(.active) {
      opacity: 0.7;
    }

    .lang-btn:hover {
      opacity: 1;
      background: rgba(255,255,255,0.15);
    }

    .connection-status {
      position: fixed;
      top: 70px;
      right: 20px;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: 500;
      z-index: 1000;
      transition: all 0.3s;
    }

    .status-online {
      background: #d1fae5;
      color: #065f46;
    }

    .status-offline {
      background: #fef3c7;
      color: #92400e;
    }

    /* Better mobile responsiveness */
    @media (max-width: 768px) {
      .modal-content {
        margin: 10px;
        max-height: 85vh;
      }
    }
  </style>
</head>
<body class="bg-gray-100 relative flex flex-col min-h-screen">

  <!-- Connection Status -->
  <div id="connectionStatus" class="connection-status status-offline">
    <span id="statusText">P≈ôipojov√°n√≠...</span>
  </div>

  <!-- Welcome Overlay -->
  <div id="welcomeOverlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[9999]">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-md mx-4 text-center">
      <h2 class="text-xl font-bold text-green-600 mb-4" data-i18n="welcome.title">V√≠tejte v Garden Pepa! üå±</h2>
      <p class="text-gray-800 mb-4" data-i18n="welcome.description1">
        Garden Pepa spojuje seniory pot≈ôebuj√≠c√≠ pomoc se zahradou a mlad√© lidi hledaj√≠c√≠ mo≈ænost vydƒõlat si pen√≠ze.
      </p>
      <p class="text-gray-700 mb-4" data-i18n="welcome.description2">
        Tato aplikace je sd√≠len√° online - ka≈æd√Ω p≈ôidan√Ω zahradn√≠k je viditeln√Ω pro v≈°echny u≈æivatele.
      </p>
      <p class="text-gray-700 mb-6" data-i18n="welcome.description3">
        P≈ôidejte se k na≈°√≠ komunitƒõ zahradn√≠k≈Ø a najdƒõte pomoc ve sv√©m okol√≠!
      </p>
      <button id="closeOverlayBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition" data-i18n="welcome.start">
        Zaƒç√≠t
      </button>
    </div>
  </div>

  <header class="bg-green-600 text-white shadow-lg p-4 flex items-center justify-between">
    <div class="flex items-center space-x-4">
      <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-2xl">üå±</div>
      <h1 class="text-3xl font-bold tracking-wide drop-shadow-lg">Garden Pepa</h1>
    </div>
    
    <!-- Language Switcher -->
    <div class="language-switcher">
      <span class="lang-btn" data-lang="cs">üá®üáø CZ</span>
      <span class="lang-btn" data-lang="en">üá¨üáß EN</span>
    </div>
  </header>

  <div id="map" class="flex-1 w-full relative">
    <div id="mapLoading" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-[1000] hidden">
      <div class="text-center">
        <div class="loading-spinner mx-auto mb-2"></div>
        <p class="text-gray-600" data-i18n="map.loading">Naƒç√≠t√°n√≠ mapy...</p>
      </div>
    </div>
  </div>

  <!-- Footer with controls -->
  <footer class="bg-white shadow-lg p-4">
    <div class="max-w-md mx-auto flex flex-col gap-2">
      <button id="toggleFormBtn" class="bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition w-full font-semibold" data-i18n="footer.addGardener">
        P≈ôidat nov√©ho zahradn√≠ka
      </button>
      
      <div class="flex gap-2">
        <button id="exportBtn" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition" data-i18n="footer.export">
          Exportovat data
        </button>
        <input type="file" id="importFile" class="hidden" accept=".json">
        <button id="importBtn" class="flex-1 bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition" data-i18n="footer.import">
          Importovat data
        </button>
      </div>
      
      <a href="profil.html" class="bg-blue-600 text-white py-2 px-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center font-semibold" data-i18n="footer.overview">
        Zobrazit p≈ôehled
      </a>
    </div>
  </footer>

  <!-- Add Gardener Form -->
  <div id="formContainer" class="fixed inset-x-0 bottom-0 bg-white rounded-t-lg shadow-2xl p-6 max-w-md mx-auto transform translate-y-full transition-transform duration-300 z-50">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-bold text-gray-800" data-i18n="form.title">P≈ôidat nov√©ho zahradn√≠ka</h3>
      <button id="closeFormBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
    </div>
    
    <form id="addGardenerForm" class="flex flex-col gap-3">
      <div>
        <input type="text" id="name" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required data-i18n-placeholder="form.name">
      </div>
      
      <div class="relative">
        <input type="text" id="city" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required autocomplete="off" data-i18n-placeholder="form.city">
        <div id="citySuggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto hidden z-10"></div>
        <div id="cityLoading" class="absolute right-3 top-3 hidden">
          <div class="loading-spinner"></div>
        </div>
      </div>
      
      <div>
        <input type="number" id="experience" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required min="0" max="100" data-i18n-placeholder="form.experience">
      </div>
      
      <div>
        <input type="url" id="photo" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" data-i18n-placeholder="form.photo">
      </div>
      
      <div>
        <textarea id="description" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent h-20 resize-none" data-i18n-placeholder="form.description"></textarea>
      </div>
      
      <div>
        <input type="text" id="freeTime" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" data-i18n-placeholder="form.availability">
      </div>
      
      <div>
        <input type="text" id="contact" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required data-i18n-placeholder="form.contact">
      </div>
      
      <div>
        <input type="text" id="idCard" class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" data-i18n-placeholder="form.idCard">
      </div>
      
      <div id="formMessages"></div>
      
      <button type="submit" id="submitBtn" class="bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold flex items-center justify-center" data-i18n="form.submit">
        <span>P≈ôidat na mapu</span>
      </button>
    </form>
  </div>

  <!-- Gardener Detail Modal -->
  <div id="gardenerModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center backdrop-blur-sm p-4">
    <div class="modal-content bg-white rounded-2xl shadow-2xl p-6 max-w-3xl w-full relative">
      <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-600 hover:text-black text-3xl font-bold z-10">&times;</button>
      
      <div class="flex justify-center mb-4">
        <img id="modalPhoto" src="https://via.placeholder.com/240x240/10b981/white?text=üë®‚Äçüåæ" alt="Gardener Photo" 
             class="w-60 h-60 object-cover rounded-full shadow-lg border-4 border-green-300 cursor-zoom-in hover:shadow-xl transition-shadow">
      </div>
      
      <h2 id="modalName" class="text-3xl font-bold text-center mt-4 text-gray-800"></h2>
      <p id="modalCity" class="text-center text-gray-600 text-lg"></p>
      <p id="modalExp" class="text-center mt-2 text-lg font-semibold text-green-600"></p>
      
      <div class="mt-6 space-y-4">
        <div id="modalDescription" class="bg-green-50 p-4 rounded-lg text-gray-700 leading-relaxed text-center"></div>
        <p id="modalFree" class="text-center italic text-gray-600"></p>
        <p id="modalContact" class="text-center font-semibold text-green-700 text-lg"></p>
        <p id="modalIdCard" class="text-center text-gray-600 text-sm"></p>
      </div>
      
      <div class="flex justify-center mt-6 space-x-3">
        <button id="deleteGardenerBtn" class="bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700 transition" data-i18n="modal.delete">
          Smazat zahradn√≠ka
        </button>
        <button id="editGardenerBtn" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition" data-i18n="modal.edit">
          Upravit √∫daje
        </button>
      </div>
    </div>
  </div>

  <!-- Fullscreen Photo Viewer -->
  <div id="fullscreenPhoto" class="flex">
    <img src="" alt="Fullscreen photo">
    <button id="closeFullscreenBtn" class="absolute top-4 right-4 text-white text-3xl font-bold hover:text-gray-300">&times;</button>
  </div>

  <script>
    // JSONBin.io Configuration
    const JSONBIN_API_KEY = '$2a$10$w8zeP5M3BNn7SmkEZjoL/O51Qv2bhbg.xTn4ar3o1BIlmbATBiJle';
    const JSONBIN_BIN_ID = '68c5a186ae596e708feda8cf';
    const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

    let isOnline = false;

    // Test JSONBin connection
    async function testConnection() {
      try {
        const response = await fetch(JSONBIN_URL + '/latest', {
          method: 'GET',
          headers: {
            'X-Master-Key': JSONBIN_API_KEY,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          isOnline = true;
          updateConnectionStatus(true);
          return true;
        }
      } catch (error) {
        console.error('JSONBin connection failed:', error);
      }
      
      isOnline = false;
      updateConnectionStatus(false);
      return false;
    }

    function updateConnectionStatus(online) {
      const statusEl = document.getElementById('connectionStatus');
      const textEl = document.getElementById('statusText');
      
      if (online) {
        statusEl.className = 'connection-status status-online';
        textEl.textContent = currentLanguage === 'cs' ? 'üåê Online' : 'üåê Online';
      } else {
        statusEl.className = 'connection-status status-offline';
        textEl.textContent = currentLanguage === 'cs' ? 'üì± Offline' : 'üì± Offline';
      }
    }

    // Translations
    const translations = {
      cs: {
        'welcome.title': 'V√≠tejte v Garden Pepa! üå±',
        'welcome.description1': 'Garden Pepa spojuje seniory pot≈ôebuj√≠c√≠ pomoc se zahradou a mlad√© lidi hledaj√≠c√≠ mo≈ænost vydƒõlat si pen√≠ze.',
        'welcome.description2': 'Tato aplikace je sd√≠len√° online - ka≈æd√Ω p≈ôidan√Ω zahradn√≠k je viditeln√Ω pro v≈°echny u≈æivatele.',
        'welcome.description3': 'P≈ôidejte se k na≈°√≠ komunitƒõ zahradn√≠k≈Ø a najdƒõte pomoc ve sv√©m okol√≠!',
        'welcome.start': 'Zaƒç√≠t',
        'map.loading': 'Naƒç√≠t√°n√≠ mapy...',
        'footer.addGardener': 'P≈ôidat nov√©ho zahradn√≠ka',
        'footer.export': 'Exportovat data',
        'footer.import': 'Importovat data',
        'footer.overview': 'Zobrazit p≈ôehled',
        'form.title': 'P≈ôidat nov√©ho zahradn√≠ka',
        'form.name': 'Cel√© jm√©no *',
        'form.city': 'Mƒõsto / obec *',
        'form.experience': 'Zku≈°enosti (roky) *',
        'form.photo': 'URL fotky (voliteln√©)',
        'form.description': 'Popis a dovednosti',
        'form.availability': 'Dostupnost (nap≈ô. v√≠kendy, dopoledne)',
        'form.contact': 'Kontakt (telefon/email) *',
        'form.idCard': 'ƒå√≠slo obƒçansk√©ho pr≈Økazu',
        'form.submit': 'P≈ôidat na mapu',
        'modal.delete': 'Smazat zahradn√≠ka',
        'modal.edit': 'Upravit √∫daje',
        'modal.experience': 'let zku≈°enost√≠',
        'modal.idCard': 'ID: ',
        'messages.success.added': 'Zahradn√≠k byl √∫spƒõ≈°nƒõ p≈ôid√°n a sd√≠len online!',
        'messages.success.deleted': 'Zahradn√≠k byl √∫spƒõ≈°nƒõ smaz√°n',
        'messages.success.exported': 'Data byla √∫spƒõ≈°nƒõ exportov√°na!',
        'messages.success.imported': 'Data byla √∫spƒõ≈°nƒõ importov√°na!',
        'messages.success.loaded': 'Naƒçteno ze sd√≠len√© datab√°ze',
        'messages.error.cityNotFound': 'Mƒõsto nebylo nalezeno. Zkuste jin√Ω n√°zev mƒõsta.',
        'messages.error.requiredFields': 'Pros√≠m vypl≈àte v≈°echna povinn√° pole',
        'messages.error.experience': 'Zku≈°enosti mus√≠ b√Ωt mezi 0 a 100 lety',
        'messages.error.coordinates': 'Nelze naj√≠t sou≈ôadnice mƒõsta. Zkontrolujte internetov√© p≈ôipojen√≠.',
        'messages.error.exportFailed': 'Chyba p≈ôi exportu dat',
        'messages.error.importFailed': 'Chyba p≈ôi ƒçten√≠ souboru. Zkontrolujte form√°t souboru.',
        'messages.error.invalidFormat': 'Neplatn√Ω form√°t souboru',
        'messages.error.loadingData': 'Chyba p≈ôi naƒç√≠t√°n√≠ dat. Pou≈æ√≠v√°m lok√°ln√≠ re≈æim.',
        'messages.error.offline': 'Offline re≈æim - zmƒõny se ulo≈æ√≠ pouze lok√°lnƒõ',
        'confirm.delete': 'Opravdu chcete smazat tohoto zahradn√≠ka?',
        'city.notFound': 'Mƒõsta nebyla nalezena'
      },
      en: {
        'welcome.title': 'Welcome to Garden Pepa! üå±',
        'welcome.description1': 'Garden Pepa connects seniors who need garden help with young people looking to earn money.',
        'welcome.description2': 'This app is shared online - every added gardener is visible to all users.',
        'welcome.description3': 'Join our community of gardeners and find help in your area!',
        'welcome.start': 'Get Started',
        'map.loading': 'Loading map...',
        'footer.addGardener': 'Add New Gardener',
        'footer.export': 'Export Data',
        'footer.import': 'Import Data',
        'footer.overview': 'View Overview',
        'form.title': 'Add New Gardener',
        'form.name': 'Full Name *',
        'form.city': 'City / Village *',
        'form.experience': 'Years of Experience *',
        'form.photo': 'Photo URL (optional)',
        'form.description': 'Description and skills',
        'form.availability': 'Availability (e.g., Weekends, Mornings)',
        'form.contact': 'Contact (Phone/Email) *',
        'form.idCard': 'ID Card Number',
        'form.submit': 'Add to Map',
        'modal.delete': 'Delete Gardener',
        'modal.edit': 'Edit Details',
        'modal.experience': 'years of experience',
        'modal.idCard': 'ID: ',
        'messages.success.added': 'Gardener successfully added and shared online!',
        'messages.success.deleted': 'Gardener deleted successfully',
        'messages.success.exported': 'Data exported successfully!',
        'messages.success.imported': 'Data imported successfully!',
        'messages.success.loaded': 'Loaded from shared database',
        'messages.error.cityNotFound': 'City not found. Please try a different city name.',
        'messages.error.requiredFields': 'Please fill in all required fields',
        'messages.error.experience': 'Experience must be between 0 and 100 years',
        'messages.error.coordinates': 'Unable to find city coordinates. Please check your internet connection.',
        'messages.error.exportFailed': 'Error exporting data',
        'messages.error.importFailed': 'Error reading file. Please check the file format.',
        'messages.error.invalidFormat': 'Invalid file format',
        'messages.error.loadingData': 'Error loading data. Using local mode.',
        'messages.error.offline': 'Offline mode - changes will be saved locally only',
        'confirm.delete': 'Are you sure you want to delete this gardener?',
        'city.notFound': 'No cities found'
      }
    };

    // Language management
    let currentLanguage = localStorage.getItem('gardenPepaLanguage') || 'en';

    function setLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem('gardenPepaLanguage', lang);
      document.documentElement.lang = lang;
      
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
      
      updateTranslations();
      updateConnectionStatus(isOnline);
    }

    function updateTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[currentLanguage] && translations[currentLanguage][key]) {
          element.textContent = translations[currentLanguage][key];
        }
      });
      
      document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (translations[currentLanguage] && translations[currentLanguage][key]) {
          element.placeholder = translations[currentLanguage][key];
        }
      });
    }

    function t(key) {
      return translations[currentLanguage] && translations[currentLanguage][key] 
        ? translations[currentLanguage][key] 
        : key;
    }

    // JSONBin.io functions
    async function loadGardenersFromJSONBin() {
      if (!isOnline) return [];
      
      try {
        const response = await fetch(JSONBIN_URL + '/latest', {
          method: 'GET',
          headers: {
            'X-Master-Key': JSONBIN_API_KEY,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          return data.record || [];
        }
      } catch (error) {
        console.error('Failed to load from JSONBin:', error);
      }
      
      return [];
    }

    async function saveGardenersToJSONBin(gardenersData) {
      if (!isOnline) return false;
      
      try {
        const response = await fetch(JSONBIN_URL, {
          method: 'PUT',
          headers: {
            'X-Master-Key': JSONBIN_API_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(gardenersData)
        });
        
        return response.ok;
      } catch (error) {
        console.error('Failed to save to JSONBin:', error);
        return false;
      }
    }

    // Language switcher event listeners
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        setLanguage(btn.dataset.lang);
        if (currentModalIndex !== null) {
          showDetails(currentModalIndex);
        }
      });
    });

    // Initialize map
    const map = L.map('map').setView([49.8, 15.5], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19,
    }).addTo(map);

    // Global variables
    let gardeners = [];
    let currentModalIndex = null;
    let citySearchTimeout = null;

    // DOM elements
    const form = document.getElementById("addGardenerForm");
    const formContainer = document.getElementById("formContainer");
    const toggleBtn = document.getElementById("toggleFormBtn");
    const closeFormBtn = document.getElementById("closeFormBtn");
    const modal = document.getElementById("gardenerModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const modalPhoto = document.getElementById("modalPhoto");
    const deleteGardenerBtn = document.getElementById("deleteGardenerBtn");
    const editGardenerBtn = document.getElementById("editGardenerBtn");
    const welcomeOverlay = document.getElementById("welcomeOverlay");
    const closeOverlayBtn = document.getElementById("closeOverlayBtn");
    const fullscreenPhoto = document.getElementById("fullscreenPhoto");
    const closeFullscreenBtn = document.getElementById("closeFullscreenBtn");
    const cityInput = document.getElementById("city");
    const citySuggestions = document.getElementById("citySuggestions");
    const cityLoading = document.getElementById("cityLoading");
    const formMessages = document.getElementById("formMessages");
    const submitBtn = document.getElementById("submitBtn");

    // Initialize app
    async function initApp() {
      setLanguage(currentLanguage);
      
      // Test connection first
      await testConnection();
      
      try {
        if (isOnline) {
          gardeners = await loadGardenersFromJSONBin();
          if (gardeners.length > 0) {
            console.log('Loaded from JSONBin:', gardeners.length, 'gardeners');
          }
        }
        
        // Fallback to localStorage if no online data
        if (gardeners.length === 0) {
          gardeners = JSON.parse(localStorage.getItem("gardeners")) || [];
          console.log('Loaded from localStorage:', gardeners.length, 'gardeners');
        }
        
        renderGardeners();
        
      } catch (error) {
        console.error('Error loading gardeners:', error);
        gardeners = JSON.parse(localStorage.getItem("gardeners")) || [];
        renderGardeners();
        showMessage(t('messages.error.loadingData'), 'error');
      }
    }

    // Event listeners
    toggleBtn.addEventListener("click", () => {
      formContainer.classList.remove('translate-y-full');
    });

    closeFormBtn.addEventListener("click", () => {
      formContainer.classList.add('translate-y-full');
    });

    closeOverlayBtn.addEventListener("click", () => {
      welcomeOverlay.style.display = 'none';
    });

    // City autocomplete
    cityInput.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      
      clearTimeout(citySearchTimeout);
      citySuggestions.classList.add('hidden');
      
      if (query.length < 2) return;
      
      cityLoading.classList.remove('hidden');
      
      citySearchTimeout = setTimeout(async () => {
        try {
          const suggestions = await searchCities(query);
          displayCitySuggestions(suggestions);
        } catch (error) {
          console.error('City search error:', error);
        } finally {
          cityLoading.classList.add('hidden');
        }
      }, 300);
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!citySuggestions.contains(e.target) && e.target !== cityInput) {
        citySuggestions.classList.add('hidden');
      }
    });

    // Form submission
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const submitSpinner = '<div class="loading-spinner"></div>';
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = submitSpinner;
      submitBtn.disabled = true;
      
      try {
        const formData = {
          name: document.getElementById("name").value.trim(),
          city: document.getElementById("city").value.trim(),
          experience: parseInt(document.getElementById("experience").value),
          photo: document.getElementById("photo").value.trim() || "https://via.placeholder.com/240x240/10b981/white?text=üë®‚Äçüåæ",
          description: document.getElementById("description").value.trim(),
          freeTime: document.getElementById("freeTime").value.trim(),
          contact: document.getElementById("contact").value.trim(),
          idCard: document.getElementById("idCard").value.trim(),
          timestamp: Date.now()
        };

        // Validation
        if (!formData.name || !formData.city || !formData.contact) {
          throw new Error(t('messages.error.requiredFields'));
        }

        if (formData.experience < 0 || formData.experience > 100) {
          throw new Error(t('messages.error.experience'));
        }

        // Get coordinates
        const coords = await getCoordinates(formData.city);
        if (!coords) {
          throw new Error(t('messages.error.cityNotFound'));
        }

        // Add gardener
        const newGardener = { ...formData, lat: coords[0], lng: coords[1] };
        gardeners.push(newGardener);
        
        // Save to JSONBin and localStorage
        let savedOnline = false;
        if (isOnline) {
          savedOnline = await saveGardenersToJSONBin(gardeners);
        }
        
        // Always save locally as backup
        localStorage.setItem("gardeners", JSON.stringify(gardeners));
        
        // Update UI
        renderGardeners();
        map.setView(coords, 13);
        
        // Reset form
        form.reset();
        formContainer.classList.add('translate-y-full');
        
        const message = savedOnline ? t('messages.success.added') : t('messages.error.offline');
        showMessage(message, savedOnline ? 'success' : 'error');
        
      } catch (error) {
        showMessage(error.message, 'error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // Modal event listeners
    closeModalBtn.addEventListener("click", closeModal);
    deleteGardenerBtn.addEventListener("click", deleteGardener);
    editGardenerBtn.addEventListener("click", editGardener);

    // Fullscreen photo
    modalPhoto.addEventListener("click", showFullscreenPhoto);
    fullscreenPhoto.addEventListener("click", closeFullscreenPhoto);
    closeFullscreenBtn.addEventListener("click", closeFullscreenPhoto);

    // Export/Import functionality
    document.getElementById('exportBtn').addEventListener('click', exportGardeners);
    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('importFile').click();
    });
    document.getElementById('importFile').addEventListener('change', importGardeners);

    // Functions
    async function searchCities(query) {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=cz,sk`);
      const data = await response.json();
      return data.map(item => ({
        name: item.display_name.split(',')[0],
        fullName: item.display_name,
        lat: parseFloat(item.lat),
        lon: parseFloat(item.lon)
      }));
    }

    function displayCitySuggestions(suggestions) {
      citySuggestions.innerHTML = '';
      
      if (suggestions.length === 0) {
        citySuggestions.innerHTML = `<div class="city-suggestion text-gray-500">${t('city.notFound')}</div>`;
      } else {
        suggestions.forEach(city => {
          const div = document.createElement('div');
          div.className = 'city-suggestion';
          div.textContent = city.name;
          div.addEventListener('click', () => {
            cityInput.value = city.name;
            citySuggestions.classList.add('hidden');
          });
          citySuggestions.appendChild(div);
        });
      }
      
      citySuggestions.classList.remove('hidden');
    }

    async function getCoordinates(city) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`);
        const data = await response.json();
        return data.length ? [parseFloat(data[0].lat), parseFloat(data[0].lon)] : null;
      } catch (error) {
        throw new Error(t('messages.error.coordinates'));
      }
    }

    function renderGardeners() {
      // Clear existing markers
      map.eachLayer(layer => { 
        if (layer instanceof L.Marker) map.removeLayer(layer); 
      });
      
      // Add markers for each gardener
      gardeners.forEach((gardener, index) => {
        const marker = L.marker([gardener.lat, gardener.lng]).addTo(map);
        marker.bindTooltip(gardener.name, { permanent: false, direction: 'top' });
        marker.on("click", () => showDetails(index));
      });
    }

    function showDetails(index) {
      currentModalIndex = index;
      const g = gardeners[index];
      
      modalPhoto.src = g.photo;
      modalPhoto.onerror = function() {
        this.src = "https://via.placeholder.com/240x240/10b981/white?text=üë®‚Äçüåæ";
      };
      
      document.getElementById("modalName").textContent = g.name;
      document.getElementById("modalCity").textContent = g.city;
      document.getElementById("modalExp").textContent = g.experience + " " + t('modal.experience');
      
      // Display only description (removed duplicate specs)
      const modalDescription = document.getElementById("modalDescription");
      if (g.description) {
        modalDescription.textContent = g.description;
        modalDescription.style.display = 'block';
      } else {
        modalDescription.style.display = 'none';
      }
      
      document.getElementById("modalFree").textContent = g.freeTime ? "üïí " + g.freeTime : "";
      document.getElementById("modalContact").textContent = g.contact ? "üìû " + g.contact : "";
      document.getElementById("modalIdCard").textContent = g.idCard ? t('modal.idCard') + g.idCard : "";
      
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    function closeModal() {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      currentModalIndex = null;
    }

    async function deleteGardener() {
      if (currentModalIndex !== null && confirm(t('confirm.delete'))) {
        gardeners.splice(currentModalIndex, 1);
        
        // Save to JSONBin and localStorage
        if (isOnline) {
          await saveGardenersToJSONBin(gardeners);
        }
        localStorage.setItem("gardeners", JSON.stringify(gardeners));
        
        renderGardeners();
        closeModal();
        showMessage(t('messages.success.deleted'), 'success');
      }
    }

    function editGardener() {
      if (currentModalIndex !== null) {
        const gardener = gardeners[currentModalIndex];
        
        // Fill form with current data
        document.getElementById("name").value = gardener.name || "";
        document.getElementById("city").value = gardener.city || "";
        document.getElementById("experience").value = gardener.experience || 0;
        document.getElementById("photo").value = gardener.photo === "https://via.placeholder.com/240x240/10b981/white?text=üë®‚Äçüåæ" ? "" : (gardener.photo || "");
        document.getElementById("description").value = gardener.description || "";
        document.getElementById("freeTime").value = gardener.freeTime || "";
        document.getElementById("contact").value = gardener.contact || "";
        document.getElementById("idCard").value = gardener.idCard || "";
        
        // Remove current gardener (will be re-added when form is submitted)
        gardeners.splice(currentModalIndex, 1);
        if (isOnline) {
          saveGardenersToJSONBin(gardeners);
        }
        localStorage.setItem("gardeners", JSON.stringify(gardeners));
        renderGardeners();
        
        closeModal();
        formContainer.classList.remove('translate-y-full');
      }
    }

    function showFullscreenPhoto() {
      const fullscreenImg = fullscreenPhoto.querySelector('img');
      fullscreenImg.src = modalPhoto.src;
      fullscreenPhoto.style.display = 'flex';
    }

    function closeFullscreenPhoto() {
      fullscreenPhoto.style.display = 'none';
    }

    function showMessage(message, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
      messageDiv.textContent = message;
      
      formMessages.innerHTML = '';
      formMessages.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }

    function exportGardeners() {
      try {
        const dataStr = JSON.stringify(gardeners, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `garden-pepa-gardeners-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showMessage(t('messages.success.exported'), 'success');
      } catch (error) {
        showMessage(t('messages.error.exportFailed'), 'error');
      }
    }

    function importGardeners(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async (event) => {
        try {
          const imported = JSON.parse(event.target.result);
          
          if (!Array.isArray(imported)) {
            throw new Error(t('messages.error.invalidFormat'));
          }
          
          // Validate imported data
          const validGardeners = imported.filter(gardener => 
            gardener.name && gardener.city && gardener.lat && gardener.lng
          );
          
          gardeners = validGardeners;
          
          // Save to JSONBin and localStorage
          if (isOnline) {
            await saveGardenersToJSONBin(gardeners);
          }
          localStorage.setItem('gardeners', JSON.stringify(gardeners));
          
          renderGardeners();
          
          if (validGardeners.length !== imported.length) {
            showMessage(`${t('messages.success.imported')} ${validGardeners.length}/${imported.length}`, 'error');
          } else {
            showMessage(t('messages.success.imported'), 'success');
          }
          
        } catch (error) {
          showMessage(t('messages.error.importFailed'), 'error');
        }
      };
      
      reader.readAsText(file);
      e.target.value = ''; // Reset file input
    }

    // Initialize the app
    initApp();
  </script>

</body>

</html>
